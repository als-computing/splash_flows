# Beamline 7.0.1.1 Flows

This page documents the workflows supported by Splash Flows at [ALS Beamline 7.0.1.1 (COSMIC Scattering)](https://als.lbl.gov/beamlines/7-0-1-1/).

## Data at 7.0.1.1

At Beamline 7.0.1.1, users generate data in an HDF5 format containing a background subtracted stack of 2D images with associated Labview metadata. Depending on the experiment, the file sizes can be greater than 100GB. A ROI is exported for each dataset.

## File Watcher

There is a file watcher on the system `QNAP` that listens for new scans that have finished writing to disk. From there, a Prefect Flow we call `dispatcher` kicks off the downstream steps:
- Copy scans in real time from a Globus collection on the `compute-dtn` server to `NERSC CFS` using Globus Transfer.
- Copy project data to `NERSC HPSS` for long-term storage (TBD).
- Analysis on HPC systems (TBD).
- Ingest into SciCat (TBD).
- Schedule data pruning from `QNAP` and `NERSC CFS`.

## Prefect Configuration

### Registered Flows

#### `dispatcher.py`

The Dispatcher Prefect Flow manages the logic for handling the order and execution of data tasks. Once a new file is written, the `dispatcher()` Flow is called. In this case, the dispatcher handles the synchronous call to `move.py`, with a potential to add additional steps (e.g. scheduling remote HPC analysis code).

#### `move.py`

Flow to process a new file at BL 7.0.1.1
1. Copy the file from `compute-dtn` to `NERSC CFS` and ingest the file path and metadata into SciCat.
2. Schedule pruning from `QNAP`.
3. Copy the file from `NERSC CFS` to `NERSC HPSS`. Ingest the archived file path in SciCat.
4. Schedule pruning from `NERSC CFS`.

## VM Details

The computing backend runs on a VM in the B15 server room that is managed by ALS IT staff.

**Name**: `flow-xpcs`
**OS**: `Ubuntu 20.02 LTS` ... **at some point should be updated to `Ubuntu 24.04 LTS`**

## Flow Diagram

## Flow Diagram
```mermaid
sequenceDiagram
    participant DET as Detector/<br/>File Watcher
    participant DISP as Prefect<br/>Dispatcher
    participant D7011 as bl7011 compute-dtn<br/>Storage
    participant GLOB as Globus<br/>Transfer
    participant CFS as NERSC<br/>CFS
    participant CAT as SciCat<br/>Metadata
    participant SFAPI as SFAPI
    participant HPC as HPC<br/>Compute
    participant HPSS as HPSS<br/>Tape
    
    %% Initial Trigger
    DET->>DET: Monitor filesystem
    DET->>DISP: Trigger on new file
    DISP->>DISP: Coordinate flows
    
    %% Flow 1: new_file_7011
    rect rgb(220, 230, 255)
        note over DISP,CAT: FLOW 1: new_file_7011
        DISP->>GLOB: Init transfer
        activate GLOB
        GLOB->>D7011: Initiate copy
        activate D7011
        D7011-->>GLOB: Copy initiated
        deactivate D7011
        %% note right of GLOB: Transfer in progress
        GLOB-->>DISP: Transfer complete
        deactivate GLOB
        
        DISP->>CAT: Register metadata
    end
    
    %% Flow 2: HPSS Transfer
    rect rgb(220, 255, 230)
        note over DISP,CAT: FLOW 2: Scheduled HPSS Transfer
        DISP->>SFAPI: Submit tape job
        activate SFAPI
        SFAPI->>HPSS: Initiate archive
        activate HPSS
        HPSS-->>SFAPI: Archive complete
        deactivate HPSS
        SFAPI-->>DISP: Job complete
        deactivate SFAPI
        
        DISP->>CAT: Update metadata
    end
    
    %% Flow 3: HPC Analysis
    rect rgb(255, 230, 230)
        note over DISP,HPC: FLOW 3: HPC Downstream Analysis
        DISP->>SFAPI: Submit compute job
        activate SFAPI
        SFAPI->>HPC: Execute job
        activate HPC
        HPC->>HPC: Process data
        HPC-->>SFAPI: Compute complete
        deactivate HPC
        SFAPI-->>DISP: Job complete
        deactivate SFAPI
        
        DISP->>CAT: Update metadata
    end
    
    %% Flow 4: Scheduled Pruning
    rect rgb(255, 255, 220)
        note over DISP,CAT: FLOW 4: Scheduled Pruning
        DISP->>DISP: Scheduled pruning trigger
        
        DISP->>D7011: Prune old files
        activate D7011
        D7011->>D7011: Delete expired data
        D7011-->>DISP: Pruning complete
        deactivate D7011
        
        DISP->>CFS: Prune old files
        activate CFS
        CFS->>CFS: Delete expired data
        CFS-->>DISP: Pruning complete
        deactivate CFS
        
        DISP->>CAT: Update metadata
    end
  ```