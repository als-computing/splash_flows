# Beamline 9.3.1 Flows

This page documents the workflows supported by Splash Flows at [ALS Beamline 9.3.1 (Tender X-ray Spectroscopy)](https://als.lbl.gov/beamlines/9-3-1/).

## Data at 9.3.1

Generates spectroscopy data.

## File Watcher

There is a file watcher on the acquisition system that listens for new scans that have finished writing to disk. From there, a Prefect Flow we call `dispatcher` kicks off the downstream steps:
- Copy scans in real time from a Globus collection on the `compute-dtn` server to `NERSC CFS` using Globus Transfer.
- Copy project data to `NERSC HPSS` for long-term storage (TBD).
- Analysis on HPC systems (TBD).
- Ingest into SciCat (TBD).
- Schedule data pruning from `compute-dtn` and `NERSC CFS`.

## Prefect Configuration

### Registered Flows

#### `dispatcher.py`

The Dispatcher Prefect Flow manages the logic for handling the order and execution of data tasks. Once a new file is written, the `dispatcher()` Flow is called. In this case, the dispatcher handles the synchronous call to `move.py`, with a potential to add additional steps (e.g. scheduling remote HPC analysis code).

#### `move.py`

Flow to process a new file at BL 9.3.1
1. Copy the file from `compute-dtn` to `NERSC CFS` and ingest the file path and metadata into SciCat.
2. Schedule pruning from `compute-dtn`.
3. Copy the file from `NERSC CFS` to `NERSC HPSS`. Ingest the archived file path in SciCat.
4. Schedule pruning from `NERSC CFS`.

## VM Details

The computing backend runs on a VM in the B15 server room that is managed by ALS IT staff.

`flow-931.als.lbl.gov`

## Flow Diagram

```mermaid
sequenceDiagram
    participant DET as Detector/<br/>File Watcher
    participant DISP as Prefect<br/>Dispatcher
    participant DTN as compute-dtn<br/>Storage
    participant GLOB as Globus<br/>Transfer
    participant CFS as NERSC<br/>CFS
    participant CAT as SciCat<br/>Metadata
    participant HPSS as NERSC<br/>HPSS

    %% Initial Trigger
    DET->>DET: Monitor filesystem
    DET->>DISP: Trigger on new file
    DISP->>DISP: Coordinate flows

    %% Flow 1: new_file_931
    rect rgb(220, 230, 255)
        note over DISP,CAT: FLOW 1: new_file_931
        DISP->>GLOB: Init transfer
        activate GLOB
        GLOB->>DTN: Read from compute-dtn
        DTN-->>GLOB: Data
        GLOB->>CFS: Write to NERSC CFS
        GLOB-->>DISP: Transfer complete
        deactivate GLOB
        
        DISP->>CAT: Register metadata (TBD)
    end

    %% Flow 2: HPSS Archive
    rect rgb(220, 255, 230)
        note over DISP,HPSS: FLOW 2: HPSS Archive (TBD)
        DISP->>GLOB: Init archive transfer
        activate GLOB
        GLOB->>CFS: Read from CFS
        CFS-->>GLOB: Data
        GLOB->>HPSS: Write to tape
        GLOB-->>DISP: Archive complete
        deactivate GLOB
        
        DISP->>CAT: Update metadata (TBD)
    end

    %% Flow 3: Scheduled Pruning
    rect rgb(255, 255, 220)
        note over DISP,CFS: FLOW 3: Scheduled Pruning
        DISP->>DISP: Schedule prune tasks
        
        DISP->>DTN: Prune from compute-dtn
        activate DTN
        DTN->>DTN: Delete expired data
        DTN-->>DISP: Pruning complete
        deactivate DTN

        DISP->>CFS: Prune from CFS (after HPSS)
        activate CFS
        CFS->>CFS: Delete expired data
        CFS-->>DISP: Pruning complete
        deactivate CFS
    end
```